---
import { getAllPostsAndSubposts } from '@/lib/data-utils'
import { cn } from '@/lib/utils'

const posts = await getAllPostsAndSubposts()

// 1. Create a map of date string (YYYY-MM-DD) -> count
const activityMap = new Map<string, number>()
posts.forEach((post) => {
  const dateObj = post.data.date
  const dateStr = dateObj.toISOString().split('T')[0]
  activityMap.set(dateStr, (activityMap.get(dateStr) || 0) + 1)
})

// 2. Generate the last 365 days
const today = new Date()
const days = []
// Start from 52 weeks ago (approx 1 year) to align weeks nicely, or just 365 days.
// GitHub usually shows exactly 1 year or 52-53 weeks.
// Let's aim for 52 full columns + current partial week.
// To keep it simple, let's just generate the last 365 days.
for (let i = 364; i >= 0; i--) {
  const d = new Date(today)
  d.setDate(d.getDate() - i)
  days.push(d)
}

// 3. Helper to determine level (0-4)
const getLevel = (count: number) => {
  if (count === 0) return 0
  if (count === 1) return 1
  if (count === 2) return 2
  if (count <= 4) return 3
  return 4
}
---

<div class="bg-card rounded-xl border p-6">
  <div class="mb-4 flex items-center justify-between">
    <h3 class="text-lg font-medium">Activity</h3>
    <span class="text-muted-foreground text-xs"
      >{posts.length} contributions in the last year</span
    >
  </div>

  <div class="overflow-x-auto pb-2">
    <div class="min-w-fit">
      <div class="grid w-fit grid-flow-col grid-rows-7 gap-1">
        {
          days.map((date) => {
            const dateStr = date.toISOString().split('T')[0]
            const count = activityMap.get(dateStr) || 0
            const level = getLevel(count)

            return (
              <div
                class={cn(
                  'size-3 rounded-sm transition-colors',
                  level === 0 && 'bg-muted',
                  level === 1 && 'bg-primary/30',
                  level === 2 && 'bg-primary/50',
                  level === 3 && 'bg-primary/75',
                  level === 4 && 'bg-primary',
                )}
                title={`${count} posts on ${dateStr}`}
              />
            )
          })
        }
      </div>
    </div>
  </div>

  <div
    class="text-muted-foreground mt-4 flex items-center justify-end gap-2 text-xs"
  >
    <span>Less</span>
    <div class="flex gap-1">
      <div class="bg-muted size-3 rounded-sm"></div>
      <div class="bg-primary/30 size-3 rounded-sm"></div>
      <div class="bg-primary/50 size-3 rounded-sm"></div>
      <div class="bg-primary/75 size-3 rounded-sm"></div>
      <div class="bg-primary size-3 rounded-sm"></div>
    </div>
    <span>More</span>
  </div>
</div>
