<style is:global>
  @keyframes shimmer {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }

  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(5px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .skeleton-shimmer {
    background-color: var(--skeleton-base);
    background-image: linear-gradient(
      90deg,
      var(--skeleton-base) 25%,
      var(--skeleton-shine) 50%,
      var(--skeleton-base) 75%
    );
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite linear;
  }

  .content-fade-in {
    animation: fade-in 0.3s ease-out forwards;
  }
</style>

<script>
  // Helper to generate list item skeleton
  const getListItemSkeleton = () => `
    <div class="flex flex-col gap-2 p-4 border rounded-lg">
      <div class="h-6 skeleton-shimmer rounded w-3/4"></div>
      <div class="h-4 skeleton-shimmer rounded w-1/2"></div>
      <div class="h-4 skeleton-shimmer rounded w-full mt-2"></div>
      <div class="h-4 skeleton-shimmer rounded w-5/6"></div>
    </div>
  `

  // Helper to get detail skeleton (existing)
  const getDetailSkeleton = () => `
    <div class="grid grid-cols-[minmax(0px,1fr)_min(calc(var(--breakpoint-md)-2rem),100%)_minmax(0px,1fr)] gap-y-6 py-8 w-full">
      <div class="col-start-2 space-y-4 text-center">
         <div class="h-10 skeleton-shimmer rounded w-3/4 mx-auto"></div>
         <div class="flex justify-center gap-4">
           <div class="h-4 skeleton-shimmer rounded w-24"></div>
           <div class="h-4 skeleton-shimmer rounded w-24"></div>
         </div>
      </div>
      
      <div class="col-start-2 space-y-4">
        <div class="h-4 skeleton-shimmer rounded w-full"></div>
        <div class="h-4 skeleton-shimmer rounded w-5/6"></div>
        <div class="h-4 skeleton-shimmer rounded w-full"></div>
        <div class="h-4 skeleton-shimmer rounded w-4/5"></div>
      </div>
      
      <div class="col-start-2 space-y-4">
        <div class="h-4 skeleton-shimmer rounded w-full"></div>
        <div class="h-4 skeleton-shimmer rounded w-11/12"></div>
        <div class="h-4 skeleton-shimmer rounded w-full"></div>
      </div>

       <div class="col-start-2 space-y-4">
        <div class="h-4 skeleton-shimmer rounded w-full"></div>
        <div class="h-4 skeleton-shimmer rounded w-5/6"></div>
        <div class="h-4 skeleton-shimmer rounded w-full"></div>
        <div class="h-4 skeleton-shimmer rounded w-4/5"></div>
      </div>
    </div>
  `

  // Helper to get list skeleton
  const getListSkeleton = () => `
    <div class="flex flex-col gap-y-4 max-w-[46rem] mx-auto py-6">
      <div class="h-8 skeleton-shimmer rounded w-48 mb-6"></div>
      <div class="space-y-4">
        ${Array(5).fill(null).map(getListItemSkeleton).join('')}
      </div>
    </div>
  `

  document.addEventListener('astro:before-preparation', (event) => {
    const main = document.querySelector('main')
    if (!main) return

    // Smart Scroll: Don't scroll to top if going back
    const isBack = event.direction === 'back'
    if (!isBack) {
      window.scrollTo({ top: 0, behavior: 'instant' })
    }

    // Determine skeleton type based on destination URL
    // event.to is the URL object of the destination
    const toUrl = new URL(event.to)
    const pathname = toUrl.pathname

    // Logic:
    // - Detail view: /blog/slug (where slug is not empty and not 'page/x' if doing pagination)
    // - List view: /, /blog, /authors, /tags

    // Simple heuristic:
    // If it starts with /blog/ and has more segments, it's likely a post.
    // EXCEPT /blog itself.
    // Also handle possible trailing slashes.
    const cleanPath = pathname.replace(/\/$/, '')

    const isBlogDetail = cleanPath.startsWith('/blog/') && cleanPath !== '/blog'

    // You might want to exclude /blog/page/2 etc if you use that structure,
    // but the current router seems to use params for pages?
    // Let's assume /blog/something is a detail page.

    if (isBlogDetail) {
      main.innerHTML = getDetailSkeleton()
    } else {
      main.innerHTML = getListSkeleton()
    }

    main.setAttribute('aria-busy', 'true')
  })

  document.addEventListener('astro:after-swap', () => {
    const main = document.querySelector('main')
    if (main) {
      main.classList.add('content-fade-in')
      main.setAttribute('aria-busy', 'false')
    }
  })
</script>
