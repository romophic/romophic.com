---
import { Icon } from 'astro-icon/components'
import { Button } from '@/components/ui/button'
import { cn } from '@/lib/utils'
---

<site-search class="contents">
  <Button
    variant="ghost"
    size="icon"
    className="relative size-8"
    id="search-trigger"
    aria-label="Search"
  >
    <Icon name="lucide:search" class="size-5" />
    <span class="sr-only">Search</span>
    <span class="sr-only">Search</span>
  </Button>

  <dialog
    id="search-dialog"
    class="backdrop:bg-background/80 fixed left-[50%] top-[20%] z-50 w-full max-w-lg translate-x-[-50%] rounded-lg border bg-background p-0 shadow-lg backdrop-blur-sm sm:top-[20%]"
  >
    <div class="flex flex-col gap-4 p-4">
      <div class="flex items-center gap-2 border-b px-2 pb-2">
        <Icon name="lucide:search" class="text-muted-foreground size-5" />
        <input
          type="text"
          id="search-input"
          class="placeholder:text-muted-foreground flex h-10 w-full rounded-md bg-transparent px-2 py-2 text-sm outline-none disabled:cursor-not-allowed disabled:opacity-50"
          placeholder="Type to search..."
          autocomplete="off"
        />
        <Button
          variant="ghost"
          size="sm"
          id="search-close"
          className="text-muted-foreground hover:text-foreground"
        >
          <span class="sr-only">Close</span>
          <Icon name="lucide:x" class="size-4" />
        </Button>
      </div>
      <div id="search-results" class="max-h-[60vh] overflow-y-auto space-y-2">
        <!-- Results will be injected here -->
        <div class="text-muted-foreground py-4 text-center text-sm">
          No results found.
        </div>
      </div>
    </div>
  </dialog>
</site-search>

<style>
  dialog::backdrop {
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
  }
  dialog[open] {
    animation: zoom-in 0.2s ease-out;
  }
  @keyframes zoom-in {
    from {
      opacity: 0;
      transform: translate(-50%, -48%) scale(0.96);
    }
    to {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
  }
</style>

<script>
  let pagefind: any

  class SiteSearch extends HTMLElement {
    constructor() {
      super()
    }

    connectedCallback() {
      const dialog = this.querySelector('#search-dialog') as HTMLDialogElement
      const trigger = this.querySelector('#search-trigger')
      const close = this.querySelector('#search-close')
      const input = this.querySelector('#search-input') as HTMLInputElement
      const resultsContainer = this.querySelector('#search-results')

      if (!trigger || !dialog || !input || !resultsContainer) return

      const openModal = async () => {
        if (!dialog.open) {
          dialog.showModal()
          input.value = ''
          resultsContainer.innerHTML = '<div class="text-muted-foreground py-4 text-center text-sm">Type to search...</div>'
          input.focus()

          if (!pagefind) {
            try {
              const pfPath = '/pagefind/pagefind.js'
              pagefind = await import(/* @vite-ignore */ pfPath)
              await pagefind.init()
            } catch (e) {
              console.error('Pagefind not found.', e)
              resultsContainer.innerHTML =
                '<div class="text-destructive py-4 text-center text-sm">Search is only available in production builds.</div>'
            }
          }
        }
      }

      const closeModal = () => {
        dialog.close()
      }

      trigger.addEventListener('click', openModal)
      close?.addEventListener('click', closeModal)

      dialog.addEventListener('click', (e) => {
        if (e.target === dialog) closeModal()
      })

      input.addEventListener('input', async (e) => {
        const query = (e.target as HTMLInputElement).value
        if (!query || !pagefind) {
          resultsContainer.innerHTML = ''
          return
        }

        const search = await pagefind.search(query)
        const fiveResults = await Promise.all(search.results.slice(0, 5).map((r: any) => r.data()))

        if (fiveResults.length === 0) {
          resultsContainer.innerHTML =
            '<div class="text-muted-foreground py-4 text-center text-sm">No results found.</div>'
          return
        }

        resultsContainer.innerHTML = fiveResults
          .map(
            (r: any) => `
          <a href="${r.url}" class="group block rounded-md border border-transparent p-3 hover:border-border hover:bg-muted/50 transition-colors">
            <div class="flex items-center justify-between">
                <div class="font-medium text-sm text-foreground group-hover:underline decoration-muted-foreground underline-offset-4 decoration-2">${r.meta.title}</div>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right size-4 -translate-x-1 opacity-0 transition-all group-hover:translate-x-0 group-hover:opacity-100 text-muted-foreground"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
            </div>
            <div class="mt-1 text-xs text-muted-foreground line-clamp-2">${r.excerpt}</div>
          </a>
        `,
          )
          .join('')
      })
    }
  }

  customElements.define('site-search', SiteSearch)
</script>
