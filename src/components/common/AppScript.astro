<script>
  // --- Theme Management ---
  function initTheme() {
    const getTheme = () => {
      if (
        typeof localStorage !== 'undefined' &&
        localStorage.getItem('theme')
      ) {
        return localStorage.getItem('theme') || 'light'
      }
      if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        return 'dark'
      }
      return 'light'
    }

    const theme = getTheme()
    document.documentElement.setAttribute('data-theme', theme)

    if (theme === 'dark') {
      document.documentElement.classList.add('dark')
    } else {
      document.documentElement.classList.remove('dark')
    }
  }

  function setupThemeToggle() {
    const handleToggleClick = (e: MouseEvent) => {
      const element = document.documentElement
      const isDark = element.classList.contains('dark')
      const newTheme = isDark ? 'light' : 'dark'

      // View Transitions API is now typed
      if (!document.startViewTransition) {
        element.classList.toggle('dark')
        element.setAttribute('data-theme', newTheme)
        localStorage.setItem('theme', newTheme)
        updateGiscusTheme()
        return
      }

      const x = e.clientX
      const y = e.clientY
      const endRadius = Math.hypot(
        Math.max(x, window.innerWidth - x),
        Math.max(y, window.innerHeight - y)
      )

      const transition = document.startViewTransition(() => {
        element.classList.toggle('dark')
        element.setAttribute('data-theme', newTheme)
        localStorage.setItem('theme', newTheme)
        updateGiscusTheme()
      })

      transition.ready.then(() => {
        const clipPath = [
          `circle(0px at ${x}px ${y}px)`,
          `circle(${endRadius}px at ${x}px ${y}px)`,
        ]
        document.documentElement.animate(
          {
            clipPath: isDark ? [...clipPath].reverse() : clipPath,
          },
          {
            duration: 400,
            easing: 'ease-in',
            pseudoElement: isDark
              ? '::view-transition-old(root)'
              : '::view-transition-new(root)',
          }
        )
      })
    }

    const toggles = document.querySelectorAll('[data-theme-toggle]')
    toggles.forEach((toggle) => {
      // Remove old listener to avoid duplicates if any
      toggle.removeEventListener('click', handleToggleClick as unknown as EventListener)
      toggle.addEventListener('click', handleToggleClick as unknown as EventListener)
    })
  }

    // --- Giscus Management ---
    interface GiscusWidget extends HTMLElement {
      theme: string
    }
  
    function updateGiscusTheme() {
      const giscus = document.querySelector('giscus-widget') as GiscusWidget
      if (!giscus) return
  
      const isDark = document.documentElement.classList.contains('dark')
      const theme = isDark ? 'transparent_dark' : 'light'
      
      // Giscus web component API
      giscus.theme = theme
    }
  function initGiscus() {
    // Initial config update
    updateGiscusTheme()
  }

    // Run immediately to prevent flash of wrong theme (critical for UX)
    initTheme()
  
    // Run immediately after the page is swapped but before it's rendered
    document.addEventListener('astro:after-swap', initTheme)
  
    // Run on every page navigation
    document.addEventListener('astro:page-load', () => {
      initTheme() // Re-apply theme just in case
      setupThemeToggle()
      initGiscus()
    })
  // Optional: Listen for system preference changes
  window
    .matchMedia('(prefers-color-scheme: dark)')
    .addEventListener('change', () => {
      if (!localStorage.getItem('theme')) {
        initTheme()
        updateGiscusTheme()
      }
    })
</script>
