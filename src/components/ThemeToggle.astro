---
import { Button } from '@/components/ui/button'
import { Icon } from 'astro-icon/components'
---

<theme-toggle class="contents">
  <Button
    variant="ghost"
    size="icon"
    title="Toggle theme"
    className="-my-2 -me-2 size-8"
  >
    <div class="relative flex items-center justify-center">
      <Icon
        name="lucide:sun"
        class="size-4 scale-100 rotate-0 transition-all duration-300 dark:scale-0 dark:-rotate-90"
      />
      <Icon
        name="lucide:moon"
        class="absolute size-4 scale-0 rotate-90 transition-all duration-300 dark:scale-100 dark:rotate-0"
      />
    </div>
    <span class="sr-only">Toggle theme</span>
  </Button>
</theme-toggle>

<script>
  class ThemeToggle extends HTMLElement {
    connectedCallback() {
      const button = this.querySelector('button')
      
      const handleToggleClick = () => {
        const element = document.documentElement
        const currentTheme = element.getAttribute('data-theme')
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark'

        element.classList.add('[&_*]:transition-none')
        element.setAttribute('data-theme', newTheme)
        if (newTheme === 'dark') {
          element.classList.add('dark')
        } else {
          element.classList.remove('dark')
        }
        
        // Force reflow
        window.getComputedStyle(element).getPropertyValue('opacity')

        requestAnimationFrame(() => {
          element.classList.remove('[&_*]:transition-none')
        })

        localStorage.setItem('theme', newTheme)
      }

      button?.addEventListener('click', handleToggleClick)
    }
  }

  customElements.define('theme-toggle', ThemeToggle)
</script>
